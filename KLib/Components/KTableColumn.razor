@using System.Linq.Expressions
@typeparam TRowData

@code {
    [CascadingParameter] public KTable<TRowData> OwnerGrid { get; set; } = null!;

    [Parameter] [EditorRequired] public string Title { get; set; } = null!;

    [Parameter] public Expression<Func<TRowData, object>>? Expression { get; set; } = null!;

    [Parameter] public string? Format { get; set; }

    [Parameter] public RenderFragment<TRowData>? ChildContent { get; set; }

    [Parameter] public bool DisableColumnOrder { get; set; }

    internal bool _sortAscending = true;
    internal Func<TRowData, object>? _compiledExpression;
    private Expression? _lastCompiledExpression;
    private RenderFragment? headerTemplate;
    private RenderFragment<TRowData>? cellTemplate;

    // Add the column to the parent Grid component.
    // OnInitialized is called only once in the component lifecycle
    protected override void OnInitialized()
    {
        OwnerGrid.AddColumn(this);
    }

    protected override void OnParametersSet()
    {
        if (_lastCompiledExpression != Expression)
        {
            _compiledExpression = Expression?.Compile();
            _lastCompiledExpression = Expression;
        }
    }

    internal RenderFragment HeaderTemplate
    {
        get
        {
            return headerTemplate ??= (builder =>
            {
                // Use the provided title or infer it from the expression
                var title = Title;

                builder.OpenElement(0, "th");

                builder.AddAttribute(1, "id", OwnerGrid.GetId(this.GetHashCode()));
                //Add onclick event to the th element
                if (OwnerGrid.AllowColumnOrder && !DisableColumnOrder && Expression != null)
                {
                    builder.AddAttribute(2, "onclick", EventCallback.Factory.Create(this, () => OwnerGrid.SortByColumn(this)));
                    //Imposto l'header come cliccabile
                    builder.AddAttribute(3, "style", "cursor:pointer");
                }

                //Aggiungo una div dentro il content dell'header
                builder.OpenElement(4, "div");
                //Nella div metto il titolo
                builder.AddContent(5, title);
                builder.CloseElement();

                builder.CloseElement();
            });
        }
    }

    internal RenderFragment<TRowData> CellTemplate
    {
        get
        {
            return cellTemplate ??= (rowData => builder =>
            {
                builder.OpenElement(0, "td");
                if (_compiledExpression != null)
                {
                    var value = _compiledExpression(rowData);
                    var formattedValue = string.IsNullOrEmpty(Format) ? value?.ToString() : string.Format("{0:" + Format + "}", value);
                    builder.AddContent(1, formattedValue);
                }
                else
                {
                    builder.AddContent(2, ChildContent, rowData);
                }

                builder.CloseElement();
            });
        }
    }

    // Get the Member name from an expression.
    // (customer => customer.Name) returns "Name"
    private static string GetMemberName<T>(Expression<T> expression)
    {
        return expression.Body switch
        {
            MemberExpression m => m.Member.Name,
            UnaryExpression u when u.Operand is MemberExpression m => m.Member.Name,
            _ => throw new NotSupportedException("Expression of type '" + expression.GetType().ToString() + "' is not supported")
        };
    }

}