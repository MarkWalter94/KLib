@using System.Linq.Expressions
@using Microsoft.AspNetCore.Components.Forms
<div>
    @if (!string.IsNullOrWhiteSpace(Placeholder))
    {
        <label for="@Id" class="form-label">@Placeholder</label>
    }
    <InputText @attributes="InputAttributes" type="@InputType" class=@($"ktextbox form-control {CssClass}")
               Value="@Text" ValueChanged="@((string? s)=>OnChange(s))" ValueExpression="@TextExpression" @oninput="OnInput"
               readonly="@Readonly"/>

</div>

@code {
    [Parameter] public string? InputType { get; set; } = "text";
    [Parameter] public string Id { get; set; } = Guid.NewGuid().ToString();
    [Parameter] public string? Placeholder { get; set; }
    [Parameter] public bool Readonly { get; set; }
    [Parameter] public TextChangedMode TextChangingMode { get; set; } = TextChangedMode.Typing;
    private string _oldText = string.Empty;
    [Parameter] [EditorRequired] public string Text { get; set; } = null!;

    [Parameter] public EventCallback<string> TextChanged { get; set; }
    [Parameter] public Expression<Func<string>>? TextExpression { get; set; }
    [Parameter] public bool ShowClearButton { get; set; }

    [Parameter] public string? CssClass { get; set; }

    // bool IsPasswordVisible = false;

    // [Parameter] public InputType Type { get; set; }

    [Parameter(CaptureUnmatchedValues = true)]
    public Dictionary<string, object> InputAttributes { get; set; } = new();

    internal void Refresh()
    {
        StateHasChanged();
    }

    // private async Task Created()
    // {
    //     if (Type == InputType.Password)
    //         await _textBoxObject.AddIconAsync("append", "e-icons e-eye", new Dictionary<string, object>() { { "onclick", EventCallback.Factory.Create<MouseEventArgs>(this, PasswordClick) } });
    // }

    // private async Task PasswordClick()
    // {
    //     IsPasswordVisible = !IsPasswordVisible;
    //     this.Type = IsPasswordVisible ? InputType.Text : InputType.Password;
    //
    //     await JSRuntime.InvokeAsync<object>("showhidePassword", _textBoxObject.ID);
    // }

    private void OnInput(ChangeEventArgs obj)
    {
        if (TextChangingMode == TextChangedMode.LostFocus)
            return;
        Text = obj.Value?.ToString() ?? string.Empty;
        TextChanged.InvokeAsync(Text);
    }

    private void OnChange(string? newVal)
    {
        if (TextChangingMode == TextChangedMode.Typing)
            return;
        Text = newVal ?? string.Empty;
        TextChanged.InvokeAsync(Text);
    }

    public enum TextChangedMode
    {
        Typing,
        LostFocus
    }

}